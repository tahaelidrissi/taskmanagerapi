name: Build and Deploy via SSH (Manual Upload)
on:
  push:
    branches:
      - docker-swarm-deploy
env:
  IMAGE_NAME: taskmanagerapi
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest .
      
      - name: Push Docker image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest
      
      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.PWD_SSH_KEY }}
      
      - name: Test SSH connection
        run: |
          echo "Testing connection to PWD..."
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=15 ${{ secrets.PWD_USERNAME }}@direct.labs.play-with-docker.com 'echo "✅ SSH connection successful!"; whoami; docker --version'
      
      - name: Copy stack.yml to PWD
        run: |
          echo "Copying stack.yml to PWD instance..."
          scp -o StrictHostKeyChecking=no -o ConnectTimeout=15 stack.yml ${{ secrets.PWD_USERNAME }}@direct.labs.play-with-docker.com:~/
          echo "✅ stack.yml copied successfully!"
      
      - name: Deploy Docker Stack
        run: |
          echo "Starting deployment..."
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${{ secrets.PWD_USERNAME }}@direct.labs.play-with-docker.com "
          echo 'Verifying stack.yml file...'
          ls -la stack.yml
          cat stack.yml
          echo 'Setting up environment...'
          export MONGO_URI='${{ secrets.MONGO_URI }}'
          echo 'Logging into Docker Hub...'
          echo '${{ secrets.DOCKERHUB_TOKEN }}' | docker login -u '${{ secrets.DOCKERHUB_USERNAME }}' --password-stdin
          echo 'Pulling latest Docker image...'
          docker pull '${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest'
          echo 'Deploying Docker stack...'
          docker stack deploy -c stack.yml --with-registry-auth taskmanager
          echo '✅ Deployment completed!'
          echo 'Stack status:'
          docker stack ls
          echo 'Service status:'
          docker service ls
          "
      
      - name: Verify Deployment
        run: |
          echo "Verifying deployment status..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.PWD_USERNAME }}@direct.labs.play-with-docker.com "
          echo 'Final deployment status:'
          docker stack ps taskmanager
          echo 'Container logs (last 20 lines):'
          docker service logs --tail 20 taskmanager_web || echo 'No logs available yet'
          "