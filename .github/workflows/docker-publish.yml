name: Build and Deploy via SSH

on:
  push:
    branches:
      - swarmdeploy

env:
  IMAGE_NAME: taskmanagerapi

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 🚀 Deploy to Docker Swarm on PWD
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: direct.labs.play-with-docker.com
          username: ${{ secrets.PWD_USERNAME }}
          key: ${{ secrets.PWD_SSH_KEY }}
          port: 22
          script: |
            set -ex

            echo "🔍 System info"
            uname -a
            docker --version
            docker info

            echo "⚙️ Init Swarm if needed"
            docker swarm init || echo "Already initialized"

            cd taskmanagerapi

            echo "📝 Creating .env"
            echo "MONGO_URI=${MONGO_URI}" > .env

            echo "🚀 Deploying stack"
            docker stack deploy -c stack.yml taskmanager
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
