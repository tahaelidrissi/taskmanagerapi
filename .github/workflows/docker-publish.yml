name: Build and Deploy via SSH
on:
  push:
    branches:
      - pwd-deployment-appleboy
env:
  IMAGE_NAME: taskmanagerapi
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest .
      
      - name: Push Docker image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:latest
      
      - name: Deploy to PWD using SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: direct.labs.play-with-docker.com
          username: ${{ secrets.PWD_USERNAME }}
          key: ${{ secrets.PWD_SSH_KEY }}
          port: 22
          debug: true
          timeout: 120s
          command_timeout: 15m
          script: |
              set -e

              echo "🔧 Pulling code and deploying stack..."
              echo "Current directory: $(pwd)"
              echo "Available space: $(df -h . | tail -1)"

              echo "🔍 Checking if Git is installed..."
              if git --version > /dev/null 2>&1; then
                echo "✅ Git is installed: $(git --version)"
              else
                echo "❌ Git is not available!"
                exit 1
              fi

              echo "📁 Checking if taskmanagerapi already exists..."
              if [ -d "taskmanagerapi" ]; then
                echo "📁 Directory taskmanagerapi already exists. Skipping clone."
              else
                echo "📥 Cloning repository with timeout..."
                if timeout 60 git clone https://github.com/tahaelidrissi/taskmanagerapi.git taskmanagerapi; then
                  echo "✅ Full clone succeeded!"
                elif timeout 60 git clone --depth 1 https://github.com/tahaelidrissi/taskmanagerapi.git taskmanagerapi; then
                  echo "⚠️ Shallow clone succeeded!"
                else
                  echo "❌ Git clone failed"
                  exit 1
                fi
              fi

              cd taskmanagerapi
              echo "📍 Current directory: $(pwd)"
              echo "📦 Contents:"
              ls -la

              echo "🔀 Checking out branch pwd-deployment-appleboy..."
              git fetch origin pwd-deployment-appleboy || exit 1
              git checkout pwd-deployment-appleboy || exit 1

              echo "📄 Verifying stack.yml exists..."
              if [ -f "stack.yml" ]; then
                echo "✅ stack.yml found"
                cat stack.yml
              else
                echo "❌ stack.yml not found"
                ls -la
                exit 1
              fi

              echo "⚙️ Git operations completed!"
              export MONGO_URI="***"

              echo "🔐 Logging into Docker Hub..."
              echo "***" | docker login -u "***" --password-stdin || exit 1

              echo "📦 Pulling Docker image..."
              docker pull "***/$IMAGE_NAME:latest" || exit 1

              echo "🚀 Deploying stack to Docker Swarm..."
              docker stack deploy -c stack.yml --with-registry-auth taskmanager || exit 1

              echo "✅ Deployment completed successfully!"
              exit 0

